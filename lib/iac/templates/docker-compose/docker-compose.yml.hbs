# Docker Compose configuration for {{projectName}}
# Environment: {{environment}}
# Generated by Snapinfra

version: '3.8'

services:
  {{#each schema.resources}}
  {{#if (eq this.type 'database')}}
  {{@key}}:
    image: {{#if (eq this.properties.engine 'postgres')}}postgres:15-alpine{{else if (eq this.properties.engine 'mysql')}}mysql:8{{else if (eq this.properties.engine 'mariadb')}}mariadb:10{{else}}postgres:15-alpine{{/if}}
    container_name: {{../projectName}}-{{@key}}
    environment:
      {{#if (eq this.properties.engine 'postgres')}}
      POSTGRES_DB: {{../projectName}}
      POSTGRES_USER: ${DB_USERNAME:-admin}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-password}
      {{else if (eq this.properties.engine 'mysql')}}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: {{../projectName}}
      MYSQL_USER: ${DB_USERNAME:-admin}
      MYSQL_PASSWORD: ${DB_PASSWORD:-password}
      {{else if (eq this.properties.engine 'mariadb')}}
      MARIADB_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-rootpassword}
      MARIADB_DATABASE: {{../projectName}}
      MARIADB_USER: ${DB_USERNAME:-admin}
      MARIADB_PASSWORD: ${DB_PASSWORD:-password}
      {{/if}}
    ports:
      - "{{#if (eq this.properties.engine 'postgres')}}5432:5432{{else if (eq this.properties.engine 'mysql')}}3306:3306{{else if (eq this.properties.engine 'mariadb')}}3306:3306{{else}}5432:5432{{/if}}"
    volumes:
      - {{@key}}_data:/var/lib/{{#if (eq this.properties.engine 'postgres')}}postgresql/data{{else if (or (eq this.properties.engine 'mysql') (eq this.properties.engine 'mariadb'))}}mysql{{/if}}
    healthcheck:
      test: {{#if (eq this.properties.engine 'postgres')}}"pg_isready -U ${DB_USERNAME:-admin}"{{else if (or (eq this.properties.engine 'mysql') (eq this.properties.engine 'mariadb'))}}["CMD", "mysqladmin", "ping", "-h", "localhost"]{{/if}}
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - {{../projectName}}_network
    {{#if this.reasoning}}
    # {{this.reasoning}}
    {{/if}}

  {{else if (eq this.type 'cache')}}
  {{@key}}:
    image: redis:7-alpine
    container_name: {{../projectName}}-{{@key}}
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - {{@key}}_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - {{../projectName}}_network
    {{#if this.reasoning}}
    # {{this.reasoning}}
    {{/if}}

  {{else if (eq this.type 'compute')}}
  {{@key}}:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: {{../projectName}}-{{@key}}
    environment:
      NODE_ENV: {{../environment}}
      PORT: ${PORT:-{{#if this.properties.containerPort}}{{this.properties.containerPort}}{{else}}3000{{/if}}}
      {{#if this.dependsOn}}
      {{#each this.dependsOn}}
      {{naming.screaming_snakeCase this}}_HOST: {{this}}
      {{#if (eq ../../schema.resources.[this].type 'database')}}
      {{#if (eq ../../schema.resources.[this].properties.engine 'postgres')}}
      DATABASE_URL: postgresql://${DB_USERNAME:-admin}:${DB_PASSWORD:-password}@{{this}}:5432/{{../../projectName}}
      {{else if (or (eq ../../schema.resources.[this].properties.engine 'mysql') (eq ../../schema.resources.[this].properties.engine 'mariadb'))}}
      DATABASE_URL: mysql://${DB_USERNAME:-admin}:${DB_PASSWORD:-password}@{{this}}:3306/{{../../projectName}}
      {{/if}}
      {{/if}}
      {{/each}}
      {{/if}}
    ports:
      - "{{#if this.properties.containerPort}}{{this.properties.containerPort}}{{else}}3000{{/if}}:{{#if this.properties.containerPort}}{{this.properties.containerPort}}{{else}}3000{{/if}}"
    volumes:
      - .:/app
      - /app/node_modules
    {{#if this.dependsOn}}
    depends_on:
      {{#each this.dependsOn}}
      {{this}}:
        condition: service_healthy
      {{/each}}
    {{/if}}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:{{#if this.properties.containerPort}}{{this.properties.containerPort}}{{else}}3000{{/if}}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - {{../projectName}}_network
    restart: unless-stopped
    {{#if this.reasoning}}
    # {{this.reasoning}}
    {{/if}}

  {{/if}}
  {{/each}}

volumes:
  {{#each schema.resources}}
  {{#if (or (eq this.type 'database') (eq this.type 'cache'))}}
  {{@key}}_data:
    driver: local
  {{/if}}
  {{/each}}

networks:
  {{projectName}}_network:
    driver: bridge
