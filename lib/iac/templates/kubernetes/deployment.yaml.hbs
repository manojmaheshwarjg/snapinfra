apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{kebabCase projectName}}-deployment
  namespace: {{kubernetes.namespace}}
  labels:
    app: {{kebabCase projectName}}
    environment: {{environment}}
    version: {{version}}
spec:
  replicas: {{compute.replicas}}
  {{#if compute.autoscaling}}
  # Managed by HPA - see hpa.yaml
  {{/if}}
  selector:
    matchLabels:
      app: {{kebabCase projectName}}
  strategy:
    type: {{kubernetes.deploymentStrategy}}
    {{#eq kubernetes.deploymentStrategy "RollingUpdate"}}
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
    {{/eq}}
  template:
    metadata:
      labels:
        app: {{kebabCase projectName}}
        environment: {{environment}}
        version: {{version}}
      annotations:
        {{#if monitoring.prometheus}}
        prometheus.io/scrape: "true"
        prometheus.io/port: "{{compute.metricsPort}}"
        prometheus.io/path: "/metrics"
        {{/if}}
    spec:
      {{#if kubernetes.serviceAccount}}
      serviceAccountName: {{kebabCase projectName}}-sa
      {{/if}}
      {{#if kubernetes.imagePullSecrets}}
      imagePullSecrets:
        - name: {{kubernetes.imagePullSecrets}}
      {{/if}}
      containers:
        - name: {{kebabCase projectName}}
          image: {{compute.image}}:{{compute.imageTag}}
          imagePullPolicy: {{compute.imagePullPolicy}}
          ports:
            - name: http
              containerPort: {{compute.port}}
              protocol: TCP
            {{#if monitoring.prometheus}}
            - name: metrics
              containerPort: {{compute.metricsPort}}
              protocol: TCP
            {{/if}}
          env:
            - name: NODE_ENV
              value: "{{environment}}"
            - name: PORT
              value: "{{compute.port}}"
            {{#each environmentVariables}}
            - name: {{uppercase key}}
              value: "{{value}}"
            {{/each}}
            {{#if database.enabled}}
            - name: DATABASE_HOST
              valueFrom:
                secretKeyRef:
                  name: {{kebabCase projectName}}-db-secret
                  key: host
            - name: DATABASE_PORT
              valueFrom:
                secretKeyRef:
                  name: {{kebabCase projectName}}-db-secret
                  key: port
            - name: DATABASE_NAME
              valueFrom:
                secretKeyRef:
                  name: {{kebabCase projectName}}-db-secret
                  key: database
            - name: DATABASE_USER
              valueFrom:
                secretKeyRef:
                  name: {{kebabCase projectName}}-db-secret
                  key: username
            - name: DATABASE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{kebabCase projectName}}-db-secret
                  key: password
            {{/if}}
          {{#if kubernetes.configMap}}
          envFrom:
            - configMapRef:
                name: {{kebabCase projectName}}-config
          {{/if}}
          resources:
            requests:
              memory: "{{compute.memoryRequest}}"
              cpu: "{{compute.cpuRequest}}"
            limits:
              memory: "{{compute.memoryLimit}}"
              cpu: "{{compute.cpuLimit}}"
          livenessProbe:
            httpGet:
              path: {{kubernetes.healthCheck.liveness}}
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: {{kubernetes.healthCheck.readiness}}
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          {{#if kubernetes.volumeMounts}}
          volumeMounts:
            {{#each kubernetes.volumeMounts}}
            - name: {{name}}
              mountPath: {{mountPath}}
              {{#if readOnly}}
              readOnly: true
              {{/if}}
            {{/each}}
          {{/if}}
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            runAsUser: 1000
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
      {{#if kubernetes.volumes}}
      volumes:
        {{#each kubernetes.volumes}}
        - name: {{name}}
          {{#eq type "emptyDir"}}
          emptyDir: {}
          {{/eq}}
          {{#eq type "configMap"}}
          configMap:
            name: {{configMapName}}
          {{/eq}}
          {{#eq type "secret"}}
          secret:
            secretName: {{secretName}}
          {{/eq}}
          {{#eq type "persistentVolumeClaim"}}
          persistentVolumeClaim:
            claimName: {{pvcName}}
          {{/eq}}
        {{/each}}
      {{/if}}
      {{#if kubernetes.nodeSelector}}
      nodeSelector:
        {{#each kubernetes.nodeSelector}}
        {{key}}: {{value}}
        {{/each}}
      {{/if}}
      {{#if kubernetes.tolerations}}
      tolerations:
        {{#each kubernetes.tolerations}}
        - key: {{key}}
          operator: {{operator}}
          value: {{value}}
          effect: {{effect}}
        {{/each}}
      {{/if}}
      {{#if kubernetes.affinity}}
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - {{kebabCase projectName}}
                topologyKey: kubernetes.io/hostname
      {{/if}}
